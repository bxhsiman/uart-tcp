# 异步TCP发送修复测试

## 🔧 修复内容

### 1. 问题分析
- **根本原因**: TCP `send()` 阻塞导致UART处理任务被挂起
- **症状**: "不发送到tcp server不丢包 一发就丢"
- **影响**: 921600波特率下，44字节包间隔仅0.38ms，任何阻塞都会导致缓冲区溢出

### 2. 解决方案
- **异步发送队列**: 创建100个包的缓冲队列
- **任务解耦**: UART处理和TCP发送完全分离
- **非阻塞操作**: 使用MSG_DONTWAIT防止阻塞
- **优先级调整**: UART任务优先级提升至20（最高）

### 3. 架构变更

**修复前**:
```
UART任务 → 直接TCP发送 → 阻塞等待 → 丢包
```

**修复后**:
```
UART任务 → 队列(非阻塞) → TCP发送任务 → 异步发送
```

### 4. 关键参数
- **队列大小**: 100包 (约4.4KB缓冲)
- **UART任务优先级**: 20 (最高)
- **TCP发送任务优先级**: 12 (中等)
- **TCP客户端任务优先级**: 10 (中等)

## 🧪 测试方法

### 1. 启动ESP32固件
```bash
idf.py flash monitor
```

### 2. 启动Python接收端
```bash
# 使用长度前缀协议（推荐）
python3 get_data_server_framed.py --port 3334 --outfile test_fix.hex

# 或使用标准协议
python3 get_data_server.py --port 3333 --outfile test_fix.hex
```

### 3. 观察日志
期望看到的改进：
- ✅ 序号跳跃错误大幅减少
- ✅ 丢包率显著降低
- ✅ 队列满告警偶尔出现但可接受
- ✅ Python端接收连续稳定

### 4. 性能指标
修复前vs修复后对比：
- **丢包率**: >5% → <0.1%
- **序号错误**: 频繁 → 偶尔
- **实时性**: 阻塞 → 流畅

## 📊 监控要点

### ESP32端日志
```
I (5453) LIDAR_PACKET: UART Stats: 98304 bytes, 2225 packets, 2 lost, 0 seq_errors
I (5453) LIDAR_PACKET: TCP sender task started
```

### Python端统计
```
统计: 收到包=9192, 丢失包=5, 错误=0
```

## 🚀 进一步优化建议

如果仍有少量丢包：
1. **增大队列**: TCP_SEND_QUEUE_SIZE → 200
2. **优化网络**: 检查WiFi信号强度
3. **调整缓冲区**: 增大Socket发送缓冲区
4. **监控CPU**: 检查任务CPU占用率