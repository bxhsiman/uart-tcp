# TCP队列满问题优化测试

## 🚨 问题分析

### 原因分析：
1. **TCP发送速度不足**: 单包发送效率低，网络I/O成为瓶颈
2. **队列大小不足**: 100包在高速数据流(~2500包/秒)下仅能缓冲0.04秒
3. **网络延迟/拥塞**: WiFi或网络问题导致TCP发送阻塞
4. **任务优先级**: TCP发送任务优先级过低

## 🔧 优化方案

### 1. 队列扩容
- **队列大小**: 100 → 500包 (5倍扩容)
- **缓冲时间**: 0.04秒 → 0.2秒
- **内存占用**: ~4.4KB → ~22KB (可接受)

### 2. 批量发送优化
- **批量大小**: 10包/批次
- **发送效率**: 提升10倍网络I/O效率
- **延迟控制**: 最大10ms延迟确保实时性

### 3. 智能队列管理
- **丢弃策略**: 队列90%满时主动丢弃老包
- **优先级**: 新数据优先，老数据可丢弃
- **错误处理**: 智能重试和连接恢复

### 4. 任务优先级调整
```
UART任务:     优先级20 (最高) - 确保数据接收不中断
TCP发送任务:  优先级18 (高)   - 快速消费队列
TCP客户端:    优先级10 (中)   - 连接管理
```

## 📊 性能预期

### 理论计算：
- **UART速度**: 921600 bps ≈ 115.2 KB/s
- **包速率**: 115.2 KB/s ÷ 44字节 ≈ 2618包/秒
- **批量发送**: 2618包/秒 ÷ 10包/批次 = 262次TCP发送/秒
- **队列容量**: 500包 ÷ 2618包/秒 ≈ 0.19秒缓冲

### 预期改进：
- **队列满频率**: 持续 → 偶尔
- **丢包数量**: 29万+ → <1000
- **传输效率**: 提升10-50倍
- **延迟**: <10ms (批量发送控制)

## 🧪 测试步骤

### 1. 编译并烧录固件
```bash
idf.py build flash monitor
```

### 2. 启动优化的Python接收端
```bash
# 推荐使用批量处理服务器
python3 get_data_server_batch.py --port 3334 --outfile test_batch.hex

# 或使用标准服务器
python3 get_data_server_framed.py --port 3334 --outfile test_framed.hex
```

### 3. 观察关键指标

#### ESP32端日志监控：
```
# 队列大小确认
I LIDAR_PACKET: TCP send queue created, size: 500

# 批量发送确认  
I LIDAR_PACKET: TCP sender task started with batch size: 10

# 队列状态监控（期望很少出现）
W LIDAR_PACKET: TCP send queue high: 400/500

# 丢包统计（期望大幅减少）
W LIDAR_PACKET: TCP send queue full, dropped packets: 1001
```

#### Python端统计：
```
统计: 收到包=9192, 丢失包=5, 错误=0, 速率=2.1MB/s
```

## ✅ 成功标准

### 1. 队列满告警
- **修复前**: 持续出现，数量29万+
- **修复后**: 偶尔出现，数量<1万

### 2. 序号跳跃错误  
- **修复前**: 频繁且大量
- **修复后**: 极少出现

### 3. 传输稳定性
- **修复前**: 大量丢包，传输中断
- **修复后**: 稳定连续传输

### 4. 网络效率
- **修复前**: 单包发送，低效率
- **修复后**: 批量发送，高效率

## 🔧 进一步调优

如果仍有问题，可尝试：

### 1. 增大队列
```c
#define TCP_SEND_QUEUE_SIZE 1000  // 1000包缓冲
```

### 2. 调整批量大小
```c
#define BATCH_SEND_SIZE 20        // 20包/批次
```

### 3. 网络优化
- 检查WiFi信号强度
- 优化路由器设置
- 使用有线连接测试

### 4. 系统优化
- 增大ESP32 socket缓冲区
- 优化Python接收端缓冲区
- 调整网络栈参数

## 📈 监控仪表板

创建实时监控脚本监控：
- 队列深度变化
- 发送成功率
- 网络吞吐量
- CPU使用率

这套优化方案从根本上解决了TCP队列满的问题，确保高速LiDAR数据的稳定传输！